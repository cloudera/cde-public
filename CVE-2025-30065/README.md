# CDE Image Update Script

This script (`cde-update-images-1231h3.sh`) updates Cloudera Data Engineering (CDE) component images to version 1.23.1-h3-b2 to address CVE-2025-30065. The script performs the following operations:

**Updates Three Components to use patched images**:
   - **Spark Runtime Image**: Updates the Spark runtime configuration in the spark-defaults ConfigMap
   - **Livy Runtime Image**: Updates the Livy runtime configuration in the DEX app ConfigMap and restarts the API deployment
   - **Livy Server Image**: Updates the Livy server deployment image


## Usage
```bash
./cde-update-images-1231h3.sh dex-app-<appid> <path-to-kubeconfig>
```

## Example Usage
```bash
./cde-update-images-1231h3.sh dex-app-ckjm5mw5 /tmp/kubeconfig-cluster-sqqhpchs
```
## Example output
```
-------------------------------------
CDE Image Update Script
Bash version: 5.2.37(1)-release
kubectl version:
Client Version: v1.30.13
Kustomize Version: v5.0.4-0.20230601165947-6ce0bf390ce3
Backups will be stored in: ./backups/20250609_105711
Logs will be written to: ./cde_update_images.log
-------------------------------------
[INFO] [2025-06-09 10:57:12] Prerequisites check passed
[INFO] [2025-06-09 10:57:12] DEX_APP_ID: dex-app-ckjm5mw5
[INFO] [2025-06-09 10:57:12] KUBECONFIG: /tmp/kubeconfig-cluster-sqqhpchs
-------------------------------------
[INFO] [2025-06-09 10:57:12] Created backup directory: ./backups/20250609_105711
[INFO] [2025-06-09 10:57:12] Environment setup completed
[INFO] [2025-06-09 10:57:12] DEX_APP_SUFFIX: ckjm5mw5
[INFO] [2025-06-09 10:57:12] SPARK_DEFAULTS_CONFIGMAP: spark-defaults-conf-config-map-dex-app-ckjm5mw5
[INFO] [2025-06-09 10:57:12] DEX_APP_CONFIGMAP: dex-app-ckjm5mw5-api-cm
[INFO] [2025-06-09 10:57:12] LIVY_SERVER_DEPLOYMENT: dex-app-ckjm5mw5-livy
[INFO] [2025-06-09 10:57:12] Starting CDE image update process with tag: 1.23.1-h3-b2
[INFO] [2025-06-09 10:57:12] Starting Spark runtime image update process
[INFO] [2025-06-09 10:57:12] Backed up configmap/spark-defaults-conf-config-map-dex-app-ckjm5mw5 to ./backups/20250609_105711/dex-app-ckjm5mw5_configmap_spark-defaults-conf-config-map-dex-app-ckjm5mw5.yaml
[INFO] [2025-06-09 10:57:13] Current Spark image: <repo_name>/cloudera/dex/dex-spark-runtime-3.3.0-7.2.16.200:1.23.1-h3-b2
[INFO] [2025-06-09 10:57:13] New Spark image will be: <repo_name>/cloudera/dex/dex-spark-runtime-3.3.0-7.2.16.200:1.23.1-h3-b2
configmap/spark-defaults-conf-config-map-dex-app-ckjm5mw5 patched (no change)
[INFO] [2025-06-09 10:57:14] Successfully patched configmap spark-defaults-conf-config-map-dex-app-ckjm5mw5
[INFO] [2025-06-09 10:57:15] Verification successful - Spark runtime image updated to 1.23.1-h3-b2
[INFO] [2025-06-09 10:57:15] Spark runtime image update completed
[INFO] [2025-06-09 10:57:15] Starting Livy runtime image update process
[INFO] [2025-06-09 10:57:16] Backed up configmap/dex-app-ckjm5mw5-api-cm to ./backups/20250609_105711/dex-app-ckjm5mw5_configmap_dex-app-ckjm5mw5-api-cm.yaml
[INFO] [2025-06-09 10:57:17] Retrieved current dex.yaml configuration
[INFO] [2025-06-09 10:57:17] Updated configuration with new tag: 1.23.1-h3-b2
configmap/dex-app-ckjm5mw5-api-cm configured
[INFO] [2025-06-09 10:57:19] Successfully updated configmap dex-app-ckjm5mw5-api-cm
[INFO] [2025-06-09 10:57:20] Verification successful - Livy runtime image updated to 1.23.1-h3-b2
[INFO] [2025-06-09 10:57:20] Restarting dex-app-api deployment
deployment.apps/dex-app-ckjm5mw5-api restarted
[INFO] [2025-06-09 10:57:21] Livy runtime image update completed
[INFO] [2025-06-09 10:57:21] Starting Livy server image update process
[INFO] [2025-06-09 10:57:22] Backed up deployment/dex-app-ckjm5mw5-livy to ./backups/20250609_105711/dex-app-ckjm5mw5_deployment_dex-app-ckjm5mw5-livy.yaml
[INFO] [2025-06-09 10:57:23] Current Livy server image: <repo_name>/cloudera/dex/dex-livy-server-3.3.0-7.2.16.200:1.23.1-h3-b2
[INFO] [2025-06-09 10:57:23] New Livy server image will be: <repo_name>/cloudera/dex/dex-livy-server-3.3.0-7.2.16.200:1.23.1-h3-b2
[INFO] [2025-06-09 10:57:24] Successfully updated deployment image
[INFO] [2025-06-09 10:57:24] Verification successful - Livy server image updated to 1.23.1-h3-b2
[INFO] [2025-06-09 10:57:25] Livy server image update completed
[INFO] [2025-06-09 10:57:25] -------------------------------------
[INFO] [2025-06-09 10:57:25] All updates completed!
[INFO] [2025-06-09 10:57:25] -------------------------------------
```